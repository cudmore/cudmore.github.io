<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Arduino + stepper motor + rotary encoder + scan image frame clock + serial logging &middot; Robert Cudmore
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!--
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  -->
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>





  <body class="layout-reverse">

    <div class="sidebar">
  <div class="container sidebar-sticky">

    
    
    <div id="sidebar">
    <!-- <nav class="sidebar-nav"> -->
      <!-- <a class="sidebar-nav-item" href="">Home</a> -->

      

	  <script>
  (function() {
    var cx = '014838221913568838622:5bpsoltbvmg';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>


		<section id="article">
		  <span class="sidebar-nav-item">Recent posts</span>
		    
		      &raquo; <a class="sidebarlink" href="/post/2015/06/08/Behavioral-acquisition-with-raspberry-arduino-video-and-scan-image/">Behavioral data acquisition with Raspberry, Arduino, Video and ScanImage</a><BR>
		    
		      &raquo; <a class="sidebarlink" href="/post/2015/06/07/Changing-default-mount-in-Apple-File-Sharing/">Changing default mount name in Apple File Sharing</a><BR>
		    
		      &raquo; <a class="sidebarlink" href="/post/2015/05/24/Non-blocking-stepper-motor-on-arduino/">Arduino + stepper motor + rotary encoder + scan image frame clock + serial logging</a><BR>
		    
		      &raquo; <a class="sidebarlink" href="/post/2015/05/05/mounting-a-usb-drive-at-boot/">Mounting a USB drive at boot</a><BR>
		    
		      &raquo; <a class="sidebarlink" href="/post/2015/05/05/X11%20on%20Raspberry/">X11 on raspberry</a><BR>
		    
		</section>

		<BR>

		<span class="sidebar-nav-item">Tag cloud</span>
		
    		<a style="font-size: 66%" href="/tags/#flask">
    		  flask
    		</a>
		
    		<a style="font-size: 106%" href="/tags/#python">
    		  python
    		</a>
		
    		<a style="font-size: 146%" href="/tags/#raspberry pi">
    		  raspberry pi
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#bokeh">
    		  bokeh
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#video">
    		  video
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#acquisition">
    		  acquisition
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#opencv">
    		  opencv
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#raspian">
    		  raspian
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#protocols">
    		  protocols
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#osx">
    		  osx
    		</a>
		
    		<a style="font-size: 80%" href="/tags/#raspberry">
    		  raspberry
    		</a>
		
    		<a style="font-size: 106%" href="/tags/#linux">
    		  linux
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#OSX">
    		  OSX
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#arduino">
    		  arduino
    		</a>
		
    		<a style="font-size: 53%" href="/tags/#ScanImage">
    		  ScanImage
    		</a>
		

		<BR>
		<BR>

		<section id="article">
		  <span class="sidebar-nav-item">Links</span>
		  &raquo; <a class="sidebarlink" href="http://robertcudmore.org">Homepage</a><BR>
		  &raquo; <a class="sidebarlink" href="https://github.com/cudmore/cudmore.github.io">Blog layout on github</a><BR>
		  &raquo; <a class="sidebarlink" href="http://www.flickr.com/cudmore">Flickr</a><BR>
		</section>
  
	</div>
<!--    </nav> -->

  </div>
</div>


    <div class="content container">

      <!-- added by bob -->
      <div class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Robert Cudmore</a>

          
              &nbsp;&nbsp;&nbsp;<small><a href="/about">about</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="/archive">archive</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="/tags">tags</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="/software">software</a></small>
          


        </h3>
		<hr style="background:#202020; border:0; height:3px" />
      </div>

      <div class="post">
  <h3 class="post-title">Arduino + stepper motor + rotary encoder + scan image frame clock + serial logging</h1>
  <span class="post-date">24 May 2015</span>
  <p>Goal here is to make an Arduino do four things simultaneously:</p>

<ol>
<li>Read a rotary encoder</li>
<li>Drive a stepper motor</li>
<li>Respond to Scan Image (SI) frame clock</li>
<li>Log all events to serial</li>
</ol>

<p>The rotary encoder and stepper motor (1,2) need to be non-blocking. All inputs (1,2,3) need to use low-level interrupts to be &#39;timing precise&#39; and not get blocked themselves.</p>

<p>Initially I wanted to log all this to Arduino memory but there is not enough on the Arduino Uno. Upgrading to Arduino Mega gives you 4x memory but still not enough. The rotary encoder fires off tons of events and if I hard code events as an array (in Arduino memory), I am limited to about 250 events. Same problem with SI frames, I am limited to about 250 frame timestamps. Arduino ProgMem does not work as it is not writable at runtime. In the future I may get an SD card shield for this?</p>

<p>For now I am having Arduino log all events to serial and am using python code (on a Raspberry Pi) to grab and save all serial events coming from Arduino. I don&#39;t like this as I am bound to miss some events or get out of synch due to general flakiness of serial.</p>

<h3>Install Arduino 1.6.x</h3>

<p>Don&#39;t upgrade the system to Debian Jesse, just pull the Arduino 1.6 packages from Debian Jesse repository.</p>

<p><a href="https://nicohood.wordpress.com/2015/01/24/installing-avr-gcc-4-8-1-and-arduino-ide-1-6-on-raspberry-pi/">https://nicohood.wordpress.com/2015/01/24/installing-avr-gcc-4-8-1-and-arduino-ide-1-6-on-raspberry-pi/</a></p>

<h3>Motor controller</h3>

<p>I am using <a href="http://www.schmalzhaus.com/EasyDriver/">EasyDriver</a></p>

<h3>Non blocking stepper motor on arduino</h3>

<p><a href="http://www.airspayce.com/mikem/arduino/AccelStepper/index.html">AccelStepper</a> Arduino library.</p>

<h3>Rotary encoder</h3>

<p>I have a &#39;Honeywell 600-128-cbl&#39;. Looking at wires as they come out of encoder...</p>

<ul>
<li>green - Ground</li>
<li>yellow -  &#39;A&#39; out --&gt;&gt; arduino 0</li>
<li>orange - &#39;B&#39; out --&gt;&gt; arduino 1</li>
<li>red - 5 Vdc</li>
</ul>

<p>Pinouts are in <a href="http://www.farnell.com/datasheets/1712854.pdf">.pdf on farnell website</a></p>

<p>Mount with nut and lockwasher
- Hex Mount Nut: 3/8 in x 32
- Internal Tooth Lockwasher</p>

<h3>Rotary encoder library</h3>

<p>A non-blocking rotary encoder library for Arduino is made by <a href="http://www.pjrc.com/teensy/td_libs_Encoder.html">pjrc</a>.</p>

<h3>Setting arbitrary interrupts on Arduino</h3>

<p>By default the Arduino Uno has low level interrupts on input pins 2 and 3. I need more interrupts. You can upgrade your Arduino board or just set low level interrupts on any input pin. I am setting A0/A1/A2 to accept <a href="http://www.geertlangereis.nl/Electronics/Pin_Change_Interrupts/PinChange_en.html">low level interrupts</a></p>

<h3>Plotting sensor data from arduino</h3>

<p>This is tricky as parsing incoming serial data is slow. It is slow on any operating system and with any CPU chip including Pentium i7 running OSX or Window, Arm processor on Raspberry Pi. The serial parsing/reading eventually finishes but to get a legitimate real-time plot requires buffering a number of values and plotting them in a batch. This is particularly important for the high bandwidth of the rotary encoder.</p>

<p>I tried three different options and dedicating myself to pyqtgraph...</p>

<ul>
<li><a href="http://matplotlib.org">Matplotlib</a>. Too slow and plots are inherently non interactive (like Matlab).</li>
<li><a href="https://processing.org">Processing</a>. Very simple to implement, good for prototyping, very powerful Java based code. In the end I want to use Python so I am ditching it for final production.</li>
<li><a href="http://www.pyqtgraph.org">PyQtGraph</a>. Python based and designed to plot within an application. HIghly interactive.</li>
</ul>

<h4>Good code for python matplotlib</h4>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://www.lebsanft.org/?p=48
</code></pre></div>
<h4>Processing on the pi</h4>

<p>Installing Processing on the PI is a little tricky.</p>

<p><a href="http://cagewebdev.com/index.php/raspberry-pi-running-processing-on-your-raspi/">http://cagewebdev.com/index.php/raspberry-pi-running-processing-on-your-raspi/</a></p>

<h4>pyqtgraph</h4>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo pip install pyqtgraph
</code></pre></div>
<h3>Gotchas</h3>

<ul>
<li>Don&#39;t connect pin 0 on Arduino, you will get arduino error
avrdude stk500_getsync(): not in sync</li>
</ul>

<h3>Put Arduino libraries in</h3>
<div class="highlight"><pre><code class="language-text" data-lang="text">/usr/share/arduino/libraries/
</code></pre></div>
<h2>Links</h2>

<ul>
<li><p>AccellStepper Arduino library<br>
<a href="http://www.airspayce.com/mikem/arduino/AccelStepper/index.html">http://www.airspayce.com/mikem/arduino/AccelStepper/index.html</a></p></li>
<li><p>Non blocking rotary encoder library for Arduino<br>
<a href="http://www.pjrc.com/teensy/td_libs_Encoder.html">http://www.pjrc.com/teensy/td_libs_Encoder.html</a></p></li>
<li><p>Setting any pin as a low level interrupt on Arduino<br>
<a href="http://www.geertlangereis.nl/Electronics/Pin_Change_Interrupts/PinChange_en.html">http://www.geertlangereis.nl/Electronics/Pin_Change_Interrupts/PinChange_en.html</a></p></li>
<li><p>easy driver motor controller<br>
<a href="http://www.schmalzhaus.com/EasyDriver/">http://www.schmalzhaus.com/EasyDriver/</a>
<a href="http://www.schmalzhaus.com/EasyDriver/Examples/EasyDriverExamples.html">http://www.schmalzhaus.com/EasyDriver/Examples/EasyDriverExamples.html</a></p></li>
<li><p>pinouts for &#39;Honeywell 600-128-cbl&#39; rotary encoder<br>
<a href="http://www.farnell.com/datasheets/1712854.pdf">http://www.farnell.com/datasheets/1712854.pdf</a></p></li>
<li><p>EasyDriver Tutorials<br>
<a href="http://bildr.org/2012/11/big-easy-driver-arduino/">http://bildr.org/2012/11/big-easy-driver-arduino/</a>
<a href="http://bildr.org/2012/11/big-easy-driver-arduino/">http://bildr.org/2012/11/big-easy-driver-arduino/</a></p></li>
<li><p>[not useful] A small fork of AccelStepper v1.3 with AF_motor (Adafruit motor shield) support<br>
<a href="https://github.com/adafruit/AccelStepper">https://github.com/adafruit/AccelStepper</a></p></li>
<li><p><a href="http://matplotlib.org">Matplotlib</a>.</p></li>
<li><p><a href="https://processing.org">Processing</a>.</p></li>
<li><p><a href="http://www.pyqtgraph.org">PyQtGraph</a>.</p></li>
</ul>

</div>

<div class="post-tags">
  Tags: 
  
    
  
  
  <a href="/tags/#arduino">arduino</a>,
  
  <a href="/tags/#python">python</a>,
  
  <a href="/tags/#raspberry pi">raspberry pi</a>
  
</div>


<div class="post-tags">
    <p><font size="-1rem">&copy;2015. <A HREF="http://robertcudmore.org">Robert Cudmore</A>.</font></p>
</div>


<span class="page-nav-item-left">
    <a rel="prev" href="/post/2015/05/05/mounting-a-usb-drive-at-boot/" title="View Mounting a USB drive at boot">&laquo; Previous</a>
</span>


<span class="page-nav-item-right">
    <a rel="next" href="/post/2015/06/07/Changing-default-mount-in-Apple-File-Sharing/" title="View ">Next &raquo;</a>
</span>



    </div>

  </body>
</html>
